-- Ultimate Roblox Super AI with Natural Voice
-- All requested features included, drop-in ready for StarterGui

-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TextToSpeechService = game:GetService("TextToSpeechService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

-- Fly Setup
local flying = false
local flySpeed = 50
local velocity = Instance.new("BodyVelocity")
velocity.MaxForce = Vector3.new(400000,400000,400000)
velocity.Velocity = Vector3.new(0,0,0)

-- GUI Setup
local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screenGui.Name = "SuperAI_GUI"

local textBox = Instance.new("TextBox")
textBox.Size = UDim2.new(0,400,0,50)
textBox.Position = UDim2.new(0.5,-200,0,50)
textBox.PlaceholderText = "Type commands or instructions..."
textBox.ClearTextOnFocus = true
textBox.Text = ""
textBox.Parent = screenGui

local chatLabel = Instance.new("TextLabel")
chatLabel.Size = UDim2.new(0,400,0,70)
chatLabel.Position = UDim2.new(0.5,-200,0,110)
chatLabel.BackgroundTransparency = 0.5
chatLabel.BackgroundColor3 = Color3.fromRGB(30,30,30)
chatLabel.TextColor3 = Color3.fromRGB(255,255,255)
chatLabel.TextScaled = true
chatLabel.TextWrapped = true
chatLabel.Text = ""
chatLabel.Parent = screenGui

-- Toggle Button
local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0,50,0,50)
toggleButton.Position = UDim2.new(0,10,0,50) -- left side
toggleButton.Text = "AI"
toggleButton.Parent = screenGui

local guiVisible = true
toggleButton.MouseButton1Click:Connect(function()
    guiVisible = not guiVisible
    textBox.Visible = guiVisible
    chatLabel.Visible = guiVisible
end)

-- Keywords & Tables
local speedKeywords = {slow=20, normal=16, fast=50, ["super fast"]=100, ultra=150}
local flyKeywords = {low=30, normal=50, high=100, ["really high"]=150, ultra=200}
local learnedCommands = {}
local learnedScripts = {}
local behaviorMemory = {}

-- Conversational Helper (GUI + Voice)
local function AIReply(msg)
    chatLabel.Text = msg
    -- Speak naturally using TextToSpeechService
    spawn(function()
        local success, err = pcall(function()
            TextToSpeechService:Speak(player, msg, Enum.TextToSpeechVoice.RobloxFemale)
        end)
    end)
    spawn(function()
        wait(5)
        if chatLabel.Text == msg then chatLabel.Text = "" end
    end)
end

-- Fly Movement
RunService.RenderStepped:Connect(function()
    if flying then
        local camCF = workspace.CurrentCamera.CFrame
        local moveDir = Vector3.new()
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + camCF.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - camCF.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - camCF.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + camCF.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir = moveDir + Vector3.new(0,1,0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then moveDir = moveDir - Vector3.new(0,1,0) end
        if moveDir.Magnitude > 0 then
            velocity.Velocity = moveDir.Unit * flySpeed
        else
            velocity.Velocity = Vector3.new(0,0,0)
        end
    end
end)

-- Natural-Language Script Generator
local function GenerateScript(instruction)
    instruction = instruction:lower()
    if instruction:match("make a button") then
        return [[
            local button = Instance.new("TextButton")
            button.Size = UDim2.new(0,100,0,50)
            button.Position = UDim2.new(0.5,-50,0.5,-25)
            button.Text = "Click Me!"
            button.Parent = game.Players.LocalPlayer.PlayerGui
        ]]
    elseif instruction:match("teleport pad") then
        return [[
            local part = Instance.new("Part")
            part.Size = Vector3.new(5,1,5)
            part.Position = game.Players.LocalPlayer.Character.HumanoidRootPart.Position + Vector3.new(0,0,10)
            part.Anchored = true
            part.BrickColor = BrickColor.new("Bright green")
            part.Parent = workspace
            part.Touched:Connect(function(hit)
                if hit.Parent:FindFirstChild("Humanoid") then
                    hit.Parent.HumanoidRootPart.CFrame = CFrame.new(hit.Position + Vector3.new(0,5,0))
                end
            end)
        ]]
    else
        return "-- Cannot generate script for instruction: "..instruction
    end
end

-- Predictive Fly
local lastJumpTime = 0
RunService.Heartbeat:Connect(function()
    if humanoid.Jump then
        if tick() - lastJumpTime < 2 and not flying then
            flying = true
            velocity.Velocity = Vector3.new(0,0,0)
            velocity.Parent = rootPart
            AIReply("Predictive Fly: Detected repeated jumps. Fly enabled.")
        end
        lastJumpTime = tick()
    end
end)

-- Command Parser (All features intact)
local function parseCommand(input)
    local cmd = input:lower()
    local understood = false

    -- Help
    if cmd:match("help") then
        understood = true
        local list = "Commands:\nfly, jump, sit, reset, noclip, teleport, speed\nLearned:\n"
        for k,_ in pairs(learnedCommands) do list=list.."- "..k.."\n" end
        for k,_ in pairs(learnedScripts) do list=list.."- "..k.." (script)\n" end
        AIReply(list)
    end

    -- Fly
    if cmd:match("fly") then
        understood = true
        flying = not flying
        if flying then
            velocity.Velocity = Vector3.new(0,0,0)
            velocity.Parent = rootPart
            AIReply("Flying enabled!")
        else
            velocity:Destroy()
            AIReply("Flying disabled!")
        end
    end

    -- Speed
    if cmd:match("speed") then
        understood = true
        local speed = 50
        for k,v in pairs(speedKeywords) do
            if cmd:match(k) then speed=v end
        end
        humanoid.WalkSpeed = speed
        AIReply("WalkSpeed set to "..speed)
    end

    -- Jump
    if cmd:match("jump") then
        understood = true
        humanoid.Jump = true
        AIReply("Jumped!")
    end

    -- Sit
    if cmd:match("sit") then
        understood = true
        humanoid.Sit = true
        AIReply("Sitting now")
    end

    -- Reset
    if cmd:match("reset") or cmd:match("normal") then
        understood = true
        humanoid.WalkSpeed = 16
        if flying then flying=false velocity:Destroy() end
        AIReply("Reset speed and flying")
    end

    -- Teleport
    if cmd:match("teleport") then
        understood = true
        local targetName = cmd:match("to (%w+)")
        if targetName then
            local targetPlayer = Players:FindFirstChild(targetName)
            if targetPlayer and targetPlayer.Character then
                rootPart.CFrame = targetPlayer.Character.HumanoidRootPart.CFrame + Vector3.new(0,3,0)
                AIReply("Teleported to "..targetName)
            else
                AIReply("Cannot find player "..targetName)
            end
        else
            AIReply("Specify player. Example: 'Teleport me to PlayerName'")
        end
    end

    -- Learn Command
    if cmd:match("learn") and cmd:match("as") then
        local name, action = cmd:match("learn (.+) as (.+)")
        if name and action then
            learnedCommands[name] = {action=action}
            AIReply("Learned command: "..name)
            understood = true
        end
    end

    for k,v in pairs(learnedCommands) do
        if cmd:match(k) then
            understood = true
            AIReply("Executing learned command: "..k.." -> "..v.action)
        end
    end

    -- Learn Script
    if cmd:match("script") and cmd:match("as") then
        local name, code = cmd:match("script (.+) as (.+)")
        if name and code then
            learnedScripts[name] = code
            AIReply("Learned script: "..name)
            understood = true
        end
    end

    for name, code in pairs(learnedScripts) do
        if cmd:match(name) then
            understood = true
            local success, err = pcall(function() loadstring(code)() end)
            if success then
                AIReply("Executed script: "..name)
            else
                AIReply("Error running script: "..err)
            end
        end
    end

    -- On-the-spot Script Generation
    if cmd:match("generate script") or cmd:match("create") then
        local instruction = cmd:match("generate script (.+)") or cmd:match("create (.+)")
        if instruction then
            local code = GenerateScript(instruction)
            local success, err = pcall(function() loadstring(code)() end)
            if success then
                AIReply("Generated and executed script for: "..instruction)
            else
                AIReply("Error executing generated script: "..err)
            end
            understood = true
        end
    end

    if not understood then
        AIReply("I didn't understand that. Type 'help' for commands.")
    end
end

-- Connect TextBox Input
textBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        parseCommand(textBox.Text)
        textBox.Text = ""
    end
end)

-- Initial Greeting
AIReply("Hello! I am your fully-featured Super AI. I can speak naturally, execute commands, learn, and generate scripts. Use the 'AI' button to hide/show GUI.")